<!DOCTYPE html>
<html>
	<head>
		<title>Page webRTC</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">

		<style>
			html,
			body {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}

			body {
				overflow: hidden;
			}

			.screen-lock {
				width: 100%;
				height: 100%;
				background-color: #f3f3f3;
			}

			.screen-lock-content {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 250px;
			}

			.screen-lock svg {
				display: block;
				margin: auto;
				fill: gray;
			}

			.screen-lock h3 {
				text-align: center;
				color: gray;
			}

			.hidden {
				display: none;
			}
		</style>
	</head>
	<body>
		<!--
		Set de svg à utiliser sur le projet.
		-->
		<svg style="display: none;">
			<defs>
				<svg id="screen-rotation"
					viewBox="0 0 24 24"
					preserveAspectRatio="xMidYMid meet"
					focusable="false"
					style="pointer-events: none; display: block; width: 100%; height: 100%;">
					<path d="M16.48 2.52c3.27 1.55 5.61 4.72 5.97 8.48h1.5C23.44 4.84 18.29 0 12 0l-.66.03 3.81 3.81 1.33-1.32zm-6.25-.77c-.59-.59-1.54-.59-2.12 0L1.75 8.11c-.59.59-.59 1.54 0 2.12l12.02 12.02c.59.59 1.54.59 2.12 0l6.36-6.36c.59-.59.59-1.54 0-2.12L10.23 1.75zm4.6 19.44L2.81 9.17l6.36-6.36 12.02 12.02-6.36 6.36zm-7.31.29C4.25 19.94 1.91 16.76 1.55 13H.05C.56 19.16 5.71 24 12 24l.66-.03-3.81-3.81-1.33 1.32z"></path>
				</svg>
				<svg id="remote">
					<path d="M509.278,393.542l-39.887-179.166c-4.14-18.636-15.288-34.545-31.39-44.796c-16.108-10.256-35.244-13.618-53.879-9.467   c-17.979,3.997-33.784,14.934-43.977,30.282h-52.971v-17.003h48.471c12.953,0,23.492-10.538,23.492-23.491v-95.95   c0-12.953-10.539-23.492-23.492-23.492H175.729c-12.953,0-23.492,10.539-23.492,23.492v95.95c0,12.953,10.539,23.491,23.492,23.491   H224.2v17.003h-52.942c-10.193-15.348-25.999-26.285-43.975-30.281c-18.637-4.15-37.773-0.79-53.882,9.466   c-16.102,10.251-27.25,26.16-31.385,44.776L1.71,393.545c-8.548,38.463,15.793,76.714,54.263,85.267   c5.127,1.14,10.363,1.717,15.561,1.717c16.001,0,31.756-5.503,44.363-15.496c12.795-10.141,21.795-24.519,25.325-40.403   l5.886-25.181c9.778,8.612,22.593,13.853,36.616,13.853c22.201,0,41.388-13.115,50.247-31.999h43.431   c8.859,18.884,28.046,31.999,50.247,31.999c13.968,0,26.736-5.2,36.499-13.751l5.6,25c3.547,15.965,12.548,30.342,25.343,40.483   c12.607,9.993,28.362,15.496,44.363,15.496c5.198,0,10.434-0.578,15.562-1.717C493.486,470.259,517.828,432.008,509.278,393.542z    M167.237,149.901v-95.95c0-4.682,3.81-8.492,8.492-8.492h133.814l-3.188,3.188c-2.929,2.929-2.929,7.678,0,10.606   c1.464,1.464,3.384,2.197,5.303,2.197s3.839-0.732,5.303-2.197l13.795-13.795h4.889c4.682,0,8.492,3.81,8.492,8.492v95.95   c0,4.682-3.81,8.491-8.492,8.491H217.823l75.151-75.15c2.929-2.929,2.929-7.678,0-10.606c-2.928-2.93-7.677-2.929-10.606,0   l-85.757,85.757h-20.881C171.047,158.392,167.237,154.583,167.237,149.901z M239.2,173.392h32.975v17.003H239.2V173.392z    M183.725,398.301c-22.318,0-40.475-18.157-40.475-40.475s18.157-40.475,40.475-40.475s40.475,18.157,40.475,40.475   S206.042,398.301,183.725,398.301z M327.649,398.301c-22.318,0-40.475-18.157-40.475-40.475s18.157-40.475,40.475-40.475   s40.475,18.157,40.475,40.475S349.967,398.301,327.649,398.301z M451.762,464.17c-4.061,0.902-8.201,1.36-12.307,1.36   c-26.21,0-49.368-18.603-55.066-44.246l-8.205-36.629c4.416-7.957,6.94-17.102,6.94-26.828c0-9.527-2.416-18.5-6.665-26.342   c4.86,1.195,9.933,1.843,15.156,1.843c34.998,0,63.47-28.473,63.47-63.47c0-9.524-2.06-18.685-6.122-27.227   c-0.887-1.866-1.878-3.71-2.946-5.483c-2.138-3.548-6.746-4.692-10.295-2.554c-3.548,2.138-4.691,6.747-2.554,10.295   c0.815,1.353,1.571,2.759,2.248,4.183c3.097,6.514,4.668,13.507,4.668,20.786c0,26.727-21.744,48.47-48.47,48.47   c-26.727,0-48.471-21.744-48.471-48.47c0-26.727,21.744-48.471,48.471-48.471c7.261,0,14.239,1.563,20.742,4.647   c3.744,1.775,8.215,0.18,9.99-3.563c1.775-3.743,0.18-8.215-3.563-9.99c-8.527-4.044-17.668-6.095-27.169-6.095   c-34.998,0-63.471,28.473-63.471,63.471c0,12.258,3.503,23.708,9.545,33.422c-3.259-0.599-6.612-0.928-10.041-0.928   c-30.589,0-55.475,24.886-55.475,55.475c0,2.881,0.222,5.712,0.647,8.476h-34.269c0.426-2.764,0.647-5.595,0.647-8.476   c0-30.589-24.886-55.475-55.475-55.475c-3.418,0-6.76,0.327-10.009,0.922c6.04-9.713,9.542-21.161,9.542-33.417   c0-9.524-2.06-18.685-6.122-27.227c-0.887-1.866-1.878-3.71-2.946-5.483c-2.138-3.548-6.746-4.692-10.295-2.554   c-3.548,2.138-4.691,6.747-2.554,10.295c0.815,1.353,1.571,2.759,2.248,4.183c3.097,6.514,4.668,13.507,4.668,20.786   c0,26.727-21.744,48.47-48.471,48.47c-26.727,0-48.47-21.744-48.47-48.47c0-26.727,21.744-48.471,48.47-48.471   c7.261,0,14.24,1.563,20.742,4.647c3.744,1.775,8.215,0.18,9.99-3.563c1.775-3.743,0.18-8.215-3.563-9.99   c-8.527-4.044-17.668-6.095-27.17-6.095c-34.998,0-63.47,28.473-63.47,63.471c0,34.998,28.473,63.47,63.47,63.47   c5.212,0,10.274-0.645,15.124-1.835c-4.246,7.839-6.661,16.81-6.661,26.334c0,9.713,2.516,18.846,6.92,26.794l-8.573,36.675   c-5.696,25.63-28.854,44.233-55.064,44.233c-4.106,0-8.247-0.458-12.306-1.36c-30.396-6.758-49.629-36.98-42.879-67.352   l40.306-179.189c3.271-14.726,12.079-27.296,24.802-35.396c12.726-8.101,27.842-10.756,42.568-7.478   c15.548,3.457,28.537,13.008,36.573,26.896c1.34,2.317,3.814,3.744,6.491,3.744h177.225c2.677,0,5.151-1.427,6.492-3.744   c7.919-13.686,21.249-23.489,36.575-26.896c14.723-3.279,29.841-0.624,42.565,7.478c12.723,8.1,21.531,20.67,24.803,35.399   l39.888,179.167C501.391,427.189,482.157,457.412,451.762,464.17z"/>
					<path d="M423.599,262.358h-7.996c-4.142,0-7.5,3.358-7.5,7.5s3.358,7.5,7.5,7.5h7.996c4.142,0,7.5-3.358,7.5-7.5   S427.741,262.358,423.599,262.358z"/>
					<path d="M367.628,262.358h-7.996c-4.142,0-7.5,3.358-7.5,7.5s3.358,7.5,7.5,7.5h7.996c4.142,0,7.5-3.358,7.5-7.5   S371.77,262.358,367.628,262.358z"/>
					<path d="M391.613,230.374c-4.142,0-7.5,3.358-7.5,7.5v7.996c0,4.142,3.358,7.5,7.5,7.5s7.5-3.358,7.5-7.5v-7.996   C399.113,233.732,395.755,230.374,391.613,230.374z"/>
					<path d="M391.613,286.345c-4.142,0-7.5,3.358-7.5,7.5v7.996c0,4.142,3.358,7.5,7.5,7.5s7.5-3.358,7.5-7.5v-7.996   C399.113,289.703,395.755,286.345,391.613,286.345z"/>
					<path d="M151.77,262.358h-7.996c-4.142,0-7.5,3.358-7.5,7.5s3.358,7.5,7.5,7.5h7.996c4.142,0,7.5-3.358,7.5-7.5   S155.912,262.358,151.77,262.358z"/>
					<path d="M95.799,262.358h-7.996c-4.142,0-7.5,3.358-7.5,7.5s3.358,7.5,7.5,7.5h7.996c4.142,0,7.5-3.358,7.5-7.5   S99.941,262.358,95.799,262.358z"/>
					<path d="M119.784,230.374c-4.142,0-7.5,3.358-7.5,7.5v7.996c0,4.142,3.358,7.5,7.5,7.5s7.5-3.358,7.5-7.5v-7.996   C127.284,233.732,123.926,230.374,119.784,230.374z"/>
					<path d="M119.784,286.345c-4.142,0-7.5,3.358-7.5,7.5v7.996c0,4.142,3.358,7.5,7.5,7.5s7.5-3.358,7.5-7.5v-7.996   C127.284,289.703,123.926,286.345,119.784,286.345z"/>
					<path d="M303.662,262.358h-95.921c-4.142,0-7.5,3.358-7.5,7.5s3.358,7.5,7.5,7.5h95.921c4.142,0,7.5-3.358,7.5-7.5   S307.804,262.358,303.662,262.358z"/>
					<path d="M199.716,350.327c-4.142,0-7.5,3.358-7.5,7.5c0,4.682-3.81,8.492-8.492,8.492s-8.491-3.81-8.491-8.492   s3.809-8.492,8.491-8.492c4.142,0,7.5-3.358,7.5-7.5s-3.358-7.5-7.5-7.5c-12.953,0-23.491,10.539-23.491,23.492   s10.538,23.492,23.491,23.492c12.954,0,23.492-10.539,23.492-23.492C207.216,353.685,203.858,350.327,199.716,350.327z"/>
					<path d="M343.641,350.327c-4.142,0-7.5,3.358-7.5,7.5c0,4.682-3.809,8.492-8.491,8.492s-8.492-3.81-8.492-8.492   s3.81-8.492,8.492-8.492c4.142,0,7.5-3.358,7.5-7.5s-3.358-7.5-7.5-7.5c-12.954,0-23.492,10.539-23.492,23.492   s10.538,23.492,23.492,23.492c12.953,0,23.491-10.539,23.491-23.492C351.141,353.685,347.783,350.327,343.641,350.327z"/>
				</svg>
			</defs>
		</svg>

		<!--
		Lock du mode portrait
		-->
		<div class="screen-lock">
			<div class="screen-lock-content">
				<svg height="150"
					width="150">
					<use xlink:href="#screen-rotation" href="#screen-rotation">
				</svg>
				<h3>Veuillez tourner l'écran afin d'être en mode paysage !</h3>
			</div>
		</div>

		<!--
		<div>
			<button>Get started</button>
		</div>
		-->

		<img>

		<script>
			var lockElm = document.querySelector('.screen-lock');

			if (screen.orientation.angle === 90) {
				lockElm.classList.add('hidden');
			}

			window.addEventListener('orientationchange', function() {
				lockElm.classList.toggle('hidden', screen.orientation.angle);
			});

			/*window.onresize = function () {
				alert('resize !!!');
			}*/
		</script>

		<script>
			var ws = new WebSocket(`ws://${location.host}`, 'echo-protocol'),
				pc = new RTCPeerConnection();

			window.commandChannel = pc.createDataChannel('command', {
				// UPD Semantics
				ordered: false,
				maxRetransmits: 0
			});
			commandChannel.onopen = function () {
				console.info('Command channel opened.');

				commandChannel.send('Client: Mon super message !');
			};
			commandChannel.onclose = function () {
				console.info('Command channel closed.');
			};

			pc.ondatachannel = function (event) {
				console.info('Client get data channel', event);

				var channel = event.channel;

				// Réception des images !
				channel.onmessage = function (e) {
					var imgElm = document.querySelector('img');

					console.info('Taille de la chaine: ', e.data.length);
					imgElm.src = 'data:image/png;base64,' + e.data;
				};
				channel.onopen = function () {
					console.info('Video channel on open.');
				};
				channel.onclose = function () {
					console.info('Video channel on close.');
				};
			};

			pc.onicecandidate = function (event) {
				console.info('Client on ICE candidate', event);

				if (event.candidate) {
					ws.send(JSON.stringify({
						type: 'icecandidate',
						data: event.candidate
					}));
				}
			};

			ws.onopen = () => {
				console.info('WebSocket is now open.');

				pc.createOffer()
					.then(offerDesc => {
						console.info('Set server local description from offer: ', offerDesc);
						return pc.setLocalDescription(offerDesc);
					}).then(() => {
						console.info('Set client remote desc from server offer');
						ws.send(JSON.stringify({
							type: 'localDescription',
							data: pc.localDescription
						}));
					});
			};

			ws.onmessage = function (event) {
				var json = JSON.parse(event.data);

				switch (json.type) {
					case 'localDescription':
						pc.setRemoteDescription(new RTCSessionDescription(json.data))
							.then(() => {
								console.info('WebRTC ready.');
							});
						break;
					case 'icecandidate':
						pc.addIceCandidate(json.data)
							.then(() => {
								console.info('Adding ICE candidate success ! Info: ', json.data);
							}).catch(error => {
								console.warn('ICE candidate error: ', error);
							});
						break;
					default:
						console.warn('Ce type de donnée n\'est pas référencé.');
				}
			};
		</script>
	</body>
</html>
