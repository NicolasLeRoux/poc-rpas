
<!DOCTYPE html>
<html>
	<head>
		<title>POC RPAS</title>
	</head>
	<body>
		<h1>POC RPAS (Local)</h1>
		<script>
			window.pcClient = new RTCPeerConnection();
			window.pcServer = new RTCPeerConnection();

			var onIceCandidate = function(pc, event) {
				var otherPc = pc === pcClient ? pcServer : pcClient;

				if (event.candidate) {
					otherPc.addIceCandidate(event.candidate)
						.then(() => {
							console.info('Adding ICE candidate success !');
						}).catch(error => {
							console.warn('ICE candidate error: ', error);
						});
				}
			};

			pcClient.onicecandidate = function (event) {
				console.info('Client on ICE candidate', event);

				onIceCandidate(pcClient, event);
			};
			pcServer.onicecandidate = function (event) {
				console.info('Server on ICE candidate', event);

				onIceCandidate(pcServer, event);
			};

			window.videoChannel = pcServer.createDataChannel('video', {
				// UPD Semantics
				ordered: false,
				maxRetransmits: 0
			});
			videoChannel.onopen = function () {
				console.info('Video channel opened.');

				videoChannel.send('Mon super message !');
			};
			videoChannel.onclose = function () {
				console.info('Video channel closed.');
			};

			pcClient.ondatachannel = function (event) {
				console.info('Client get data channel', event);

				var channel = event.channel;

				channel.onmessage = function (e) {
					console.info('Video channel on message: ', e.data);
				};
				channel.onopen = function () {
					console.info('Video channel on open.');
				};
				channel.onclose = function () {
					console.info('Video channel on close.');
				};
			};

			console.info('Server create offer');
			pcServer.createOffer()
				.then(offerDesc => {
					console.info('Set server local description from offer: ', offerDesc);
					return pcServer.setLocalDescription(offerDesc);
				}).then(() => {
					console.info('Set client remote desc from server offer');
					return pcClient.setRemoteDescription(pcServer.localDescription);
				}).then(() => {
					console.info('Client create answer');
					return pcClient.createAnswer();
				}).then(answerDesc => {
					console.info('Set client local desc from answer: ', answerDesc);
					return pcClient.setLocalDescription(answerDesc);
				}).then(() => {
					console.info('Set server remote desc from client answer');
					pcServer.setRemoteDescription(pcClient.localDescription);
				}).catch(error => {
					console.warn(error);
				});
		</script>
	</body>
</html>
