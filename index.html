<!DOCTYPE html>
<html>
	<head>
		<title>POC RPAS</title>
		<style>
			video {
				width: 200px;
			}
		</style>
	</head>
	<body>
		<h1>POC RPAS</h1>
		<video></video>
		<script>
			/**
			Méthode permettant de faire la capture de stream de la webcam
			*/
			var capture = function () {
				navigator.getUserMedia({
					video: true,
					audio: false
				}, function(stream) {
					var videoElm = document.querySelector('video');
				
					// Ajout du flux vidéo dans la balise vidéo.
					videoElm.srcObject = stream;

					videoElm.onloadedmetadata = function (e) {
						console.log('Loaded data: ', e);

						videoElm.play();
					};
				}, function (error) {
					console.warn('Mon erreur: ', error);
				});
			};

			//capture();

			var localDescCreated = function (desc) {
				console.log('localDescCreated: ', desc);

				peerCo.setLocalDescription(desc)
					.then(function() {
						return fetch('http://localhost:8080/setClientDescription', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify(peerCo.localDescription)
						});
					}).then(function(res) {
						return res.json;
					});
			};

			var logError = function () {
				console.log('logError');
			};

			window.peerCo;
			var start = function () {
				peerCo = new RTCPeerConnection();

				peerCo.onicecandidate = function (event) {
					if(event.candidate) {
						console.log('New route: ', event.candidate);
					}
				};

				peerCo.onnegotiationneeded = function () {
					console.log('Generation de l\'offre');
				};

				peerCo.onaddstream = function (event) {
					console.log('Reception flux vidéo.');
				};

				fetch('http://localhost:8080/getServerDescription')
					.then(function (res) {
						return res.json();
					}).then(function(json) {
						console.log('JSON: ', json);
						return peerCo.setRemoteDescription(new RTCSessionDescription(json));
					}).then(function () {
						if (peerCo.remoteDescription.type === 'offer') {
							peerCo.createAnswer(localDescCreated, logError);
						}
					});
			};

			start();
		</script>
	</body>
</html>

